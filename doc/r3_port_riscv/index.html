<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="The RISC-V port for the R3 kernel."><meta name="keywords" content="rust, rustlang, rust-lang, r3_port_riscv"><title>r3_port_riscv - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../dark.css" disabled><link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../storage.js"></script><script defer src="../crates.js"></script><script defer src="../main.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../favicon.svg"><style type="text/css">
/* Cover image, something that is definitely relevant to the subject */
.distractor {
    margin: 0 auto;
    max-width: 600px;
}
.distractor > a {
    display: block;
    background-size: cover;
    /* background: ...; — specified by inline style */
    /* padding-bottom: ...; — specified by inline style */
}

/* #![doc(html_logo_url = ...)] */
body.theme-dark .logo-container > img[src$="logo-small.svg"] {
    filter: brightness(0) invert(1) brightness(0.9);
}
body.theme-ayu .logo-container > img[src$="logo-small.svg"] {
    filter: brightness(0) invert(1) brightness(0.85);
}

/* Table of contents */
.toc-header + ul {
    background: rgba(128, 128, 128, 0.1);
    margin: 1em 0; padding: 1em;
    width: 40%;
    min-width: 280px;
    border: 1px solid rgba(128, 128, 128, 0.2);
    font-family: 'Fira Sans'; /* The UI/heading font of rustdoc */
    font-size: 95%;
}
.toc-header + ul::before {
    content: "Contents";
    font-weight: bold;
}
.toc-header + ul ul { margin-bottom: 0; }
.toc-header + ul li { list-style: none; }

/* Poor man's admonition
 *
 * # Usage
 *
 * ## Normal
 *
 *     <div class="admonition-follows"></div>
 *
 *     > **Title:** lorem ipsum lorem ipsum lorem ipsum lorem ipsum lorem ipsum
 *     > lorem ipsum
 *
 * ## Collapsible
 *
 *     <div class="admonition-follows"></div>
 *
 *     > <details>
 *     > <summary>Title</summary>
 *     >
 *     > lorem ipsum lorem ipsum lorem ipsum lorem ipsum lorem ipsum lorem ipsum
 *     >
 *     > </details>
 */
.admonition-follows + blockquote {
    background: rgba(128, 128, 128, 0.1) !important;
    margin: 1em !important; padding: 1em 1em 0 !important;
    color: inherit !important; overflow: hidden;
}
.admonition-follows + blockquote::after { /* collapsible padding */
    content: ""; display: block; margin-top: 1em;
}

.admonition-follows + blockquote summary {
    cursor: pointer;
    will-change: opacity;
    user-select: none;
    -webkit-user-select: none;
    font-weight: bold;
}
.admonition-follows + blockquote summary:not([open]):not(:hover) {
    opacity: 0.5;
}
.admonition-follows + blockquote summary + * {
    margin-top: 1em;
}

/* Display a warning if some Cargo features are disabled. */
.disabled-feature-warning > p > span:before { content: "Warning:"; font-weight: bold; }
.disabled-feature-warning > p > span:after { content: " This documentation was built without a "; }
.disabled-feature-warning > p > code:before { content: "--all-features"; }
.disabled-feature-warning > p:after { content: " build option. Some items might be missing."; }

/* Center an inline image
 *
 * # Usage
 *
 *    <span class="center">![kernel-traits]</span>
 *
 *    [kernel-traits]: data:image/svg+xml;base64,< super long base64 data >
 *
 * The image wouldn't render if `![kernel-traits]` were wrapped with `<center>`
 * because the Markdown processor doesn't do Markdown processing inside a block
 * element. On the other hand, it thinks `<span>` is an inline element (by
 * default), so markups inside `<span>` are processed.
 *
 * For diagrams processed by `::svgbobdoc`, just use `<center>`.
 */
span.center {
    display: block;
    text-align: center;
}

/* Add margins to SvgBob images */
span.center img, center img {
    border: 10px solid white;
    background: white;
}

/* Auto-invert SvgBob images in a dark theme */
body.theme-dark span.center img, body.theme-dark center img {
    filter: invert(88%);
}

body.theme-ayu span.center img, body.theme-ayu center img {
    filter: invert(89%) sepia(90%) hue-rotate(180deg);
}

/* FIXME: rustdoc's intra-doc processor generates a warning when it encounters a
   bracketed text with an unknown link target. This misfires for CSS attribute
   selectors. Make rustdoc happy by defining a fake link target. I'm not sure if
   it's worth reporting.

[open]: #dummy

*/
</style>
<script type="application/javascript">
<!--
// Monitors the current rustdoc theme and adds `.theme-NAME` to `<body>`
function initThemeMonitor() {
    if (typeof switchTheme !== 'function' ||
        typeof themeStyle !== 'object' ||
        typeof document.body.classList === 'undefined')
    {
        // Something is wrong, don't do anything
        return;
    }

    var currentClassName = null;
    function onApplyTheme(name) {
        if (currentClassName != null) {
            document.body.classList.remove(currentClassName);
        }
        currentClassName = "theme-" + name;
        document.body.classList.add(currentClassName);
    }

    var match = themeStyle.href.match(/\/([a-z]+)(-[-a-zA-Z0-9.]*)?\.css$/);
    var currentStyle = (match && match[1]) || "light";
    onApplyTheme(currentStyle);

    // Intercept calls to `switchTheme`
    var originalSwitchTheme = switchTheme;
    switchTheme = function (_0, _1, newTheme) {
        onApplyTheme(newTheme);
        originalSwitchTheme.apply(this, arguments);
    };
}

if (document.readyState === 'interactive' || document.readyState === 'complete') {
    initThemeMonitor();
} else {
    document.addEventListener('DOMContentLoaded', initThemeMonitor);
}
-->
</script>
</head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../r3_port_riscv/index.html"><div class="logo-container"><img src="https://r3-os.github.io/r3/logo-small.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../r3_port_riscv/index.html"><div class="logo-container">
                    <img src="https://r3-os.github.io/r3/logo-small.svg" alt="logo"></div></a><h2 class="location"><a href="#">Crate r3_port_riscv</a></h2><div class="sidebar-elems"><div class="block"><ul><li class="version">Version 0.3.0</li><li><a id="all-types" href="all.html">All Items</a></li></ul></div><section><div class="block"><ul><li><a href="#modules">Modules</a></li><li><a href="#macros">Macros</a></li><li><a href="#constants">Constants</a></li><li><a href="#traits">Traits</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../r3_port_riscv/index.html">
                        <img src="https://r3-os.github.io/r3/logo-small.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Crate <a class="mod" href="#">r3_port_riscv</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../src/r3_port_riscv/lib.rs.html#1-284">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>The RISC-V port for <a href="../r3_kernel/index.html">the R3 kernel</a>.</p>
<h2 id="startup-code"><a href="#startup-code">Startup code</a></h2>
<p><a href="macro.use_rt.html" title="use_rt!"><code>use_rt!</code></a> hooks up the entry points (<a href="trait.EntryPoint.html" title="EntryPoint"><code>EntryPoint</code></a>) using <code>#[</code>[<code>::riscv_rt::entry</code>]<code>]</code> (requires the <strong><code>riscv-rt</code></strong> Cargo feature). If this is not desirable for some reason, you can opt not to use it and call the entry points in other ways.</p>
<h2 id="interrupts"><a href="#interrupts">Interrupts</a></h2>
<p>This port supports the basic interrupt handling model from the RISC-V specification.</p>
<p>Other interrupt handling models such as <a href="https://github.com/riscv/riscv-fast-interrupt">RISC-V Core-Local Interrupt Controller</a> are not supported.</p>
<h3 id="local-interrupts"><a href="#local-interrupts">Local Interrupts</a></h3>
<p>The first few interrupt numbers are allocated for interrupts defined by the RISC-V privileged architecture (Machine software interrupts, timer interrupts, and external interrupts), which we collectively call <strong>local interrupts</strong>. The <a href="../r3_core/kernel/interrupt/struct.StaticInterruptHandler.html">second-level interrupt handlers</a> for these interrupt numbers are called with their respective interrupts disabled (<code>mie.M[STE]IE = 0</code>) and global interrupts enabled (<code>mstatus.MIE = 1</code>).</p>
<div><table><thead><tr><th>Interrupt Type</th><th>Interrupt Number</th><th>Can <a href="../r3_core/kernel/interrupt/struct.InterruptLine.html#method.pend">Pend</a>?</th></tr></thead><tbody>
<tr><td>Software</td><td><a href="constant.INTERRUPT_SOFTWARE.html" title="INTERRUPT_SOFTWARE"><code>INTERRUPT_SOFTWARE</code></a></td><td>Yes</td></tr>
<tr><td>Timer</td><td><a href="constant.INTERRUPT_TIMER.html" title="INTERRUPT_TIMER"><code>INTERRUPT_TIMER</code></a></td><td>No</td></tr>
<tr><td>External</td><td><a href="constant.INTERRUPT_EXTERNAL.html" title="INTERRUPT_EXTERNAL"><code>INTERRUPT_EXTERNAL</code></a></td><td>No</td></tr>
</tbody></table>
</div>
<p>The local interrupts <strong>follow a fixed priority scheme</strong> in which they are handled in the following decreasing priority order: External, Software, Timer. Interrupts with a higher priority can preempt lower ones, but not the other way. This is realized by carefully controlling the enable bits in the top-level interrupt handler.</p>
<p>The interrupt handler of a particular interrupt number can re-enable the interrupts of the said interrupt number to allow re-entry by preemption (this is useful for external interrupts, which usually have multiple interrupt sources with varying priorities).</p>
<p>The local interrupts are always enabled from an API point of view. <strong><a href="../r3_core/kernel/interrupt/struct.InterruptLine.html#method.disable"><code>InterruptLine::disable</code></a> will always return <a href="../r3_core/kernel/error/enum.EnableInterruptLineError.html#variant.NotSupported"><code>NotSupported</code></a></strong>.</p>
<div class="admonition-follows"></div>
<blockquote>
<p><strong>Rationale:</strong> Because their enable bits are toggled frequently in the top-level interrupt handler, removing the ability to disable these interrupts simplifies the implementation and reduces interupt latency. This should pose no problems in most cases.</p>
</blockquote>
<p>The local interrupts are always <a href="../r3_core/index.html#interrupt-handling-framework"><em>managed</em></a>. This is because CPU Lock is currently mapped to <code>mstatus.MIE</code> (global interrupt-enable).</p>
<h3 id="interrupt-controller"><a href="#interrupt-controller">Interrupt Controller</a></h3>
<p>The remaining interrupt numbers (≥ <a href="constant.INTERRUPT_PLATFORM_START.html" title="INTERRUPT_PLATFORM_START"><code>INTERRUPT_PLATFORM_START</code></a>) are controlled by <strong>an interrupt controller driver</strong>.</p>
<p><span class="center"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2ODAiIGhlaWdodD0iMjQwIiBzdHlsZT0idHJhbnNmb3JtOnRyYW5zbGF0ZSgwLjVweCwwLjVweCkiPgogICAgPHN0eWxlPgogICAgICAgIGxpbmUsIHBhdGgsIGNpcmNsZSwgcmVjdCwgcG9seWdvbntzdHJva2U6YmxhY2s7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLW9wYWNpdHk6MTtmaWxsLW9wYWNpdHk6MTtzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46bWl0ZXI7fXRleHR7Zm9udC1mYW1pbHk6J1NvdXJjZSBDb2RlIFBybycsJ0FuZGFsZSBNb25vJywnU2Vnb2UgVUkgTW9ubycsJ0RlamF2dSBTYW5zIE1vbm8nLCdDb25zb2xhcycsbW9ub3NwYWNlO2ZvbnQtc2l6ZToxM3B4O31yZWN0LmJhY2tkcm9we3N0cm9rZTpub25lO2ZpbGw6d2hpdGU7fS5icm9rZW57c3Ryb2tlLWRhc2hhcnJheTo4O30uZmlsbGVke2ZpbGw6YmxhY2s7fS5iZ19maWxsZWR7ZmlsbDp3aGl0ZTt9Lm5vZmlsbHtmaWxsOndoaXRlO30uZW5kX21hcmtlZF9hcnJvd3ttYXJrZXItZW5kOnVybCgjYXJyb3cpO30uc3RhcnRfbWFya2VkX2Fycm93e21hcmtlci1zdGFydDp1cmwoI2Fycm93KTt9LmVuZF9tYXJrZWRfZGlhbW9uZHttYXJrZXItZW5kOnVybCgjZGlhbW9uZCk7fS5zdGFydF9tYXJrZWRfZGlhbW9uZHttYXJrZXItc3RhcnQ6dXJsKCNkaWFtb25kKTt9LmVuZF9tYXJrZWRfY2lyY2xle21hcmtlci1lbmQ6dXJsKCNjaXJjbGUpO30uc3RhcnRfbWFya2VkX2NpcmNsZXttYXJrZXItc3RhcnQ6dXJsKCNjaXJjbGUpO30uZW5kX21hcmtlZF9vcGVuX2NpcmNsZXttYXJrZXItZW5kOnVybCgjb3Blbl9jaXJjbGUpO30uc3RhcnRfbWFya2VkX29wZW5fY2lyY2xle21hcmtlci1zdGFydDp1cmwoI29wZW5fY2lyY2xlKTt9LmVuZF9tYXJrZWRfYmlnX29wZW5fY2lyY2xle21hcmtlci1lbmQ6dXJsKCNiaWdfb3Blbl9jaXJjbGUpO30uc3RhcnRfbWFya2VkX2JpZ19vcGVuX2NpcmNsZXttYXJrZXItc3RhcnQ6dXJsKCNiaWdfb3Blbl9jaXJjbGUpO30KICAgICAgICA8IS0tc2VwYXJhdG9yLS0+CiAgICAgICAgCiAgICA8L3N0eWxlPgogICAgPGRlZnM+CiAgICAgICAgPG1hcmtlciBpZD0iYXJyb3ciIHZpZXdCb3g9Ii0yIC0yIDggOCIgcmVmWD0iNCIgcmVmWT0iMiIgbWFya2VyV2lkdGg9IjciIG1hcmtlckhlaWdodD0iNyIgb3JpZW50PSJhdXRvLXN0YXJ0LXJldmVyc2UiPgogICAgICAgICAgICA8cG9seWdvbiBwb2ludHM9IjAsMCAwLDQgNCwyIDAsMCI+PC9wb2x5Z29uPgogICAgICAgIDwvbWFya2VyPgogICAgICAgIDxtYXJrZXIgaWQ9ImRpYW1vbmQiIHZpZXdCb3g9Ii0yIC0yIDggOCIgcmVmWD0iNCIgcmVmWT0iMiIgbWFya2VyV2lkdGg9IjciIG1hcmtlckhlaWdodD0iNyIgb3JpZW50PSJhdXRvLXN0YXJ0LXJldmVyc2UiPgogICAgICAgICAgICA8cG9seWdvbiBwb2ludHM9IjAsMiAyLDAgNCwyIDIsNCAwLDIiPjwvcG9seWdvbj4KICAgICAgICA8L21hcmtlcj4KICAgICAgICA8bWFya2VyIGlkPSJjaXJjbGUiIHZpZXdCb3g9IjAgMCA4IDgiIHJlZlg9IjQiIHJlZlk9IjQiIG1hcmtlcldpZHRoPSI3IiBtYXJrZXJIZWlnaHQ9IjciIG9yaWVudD0iYXV0by1zdGFydC1yZXZlcnNlIj4KICAgICAgICAgICAgPGNpcmNsZSBjeD0iNCIgY3k9IjQiIHI9IjIiIGNsYXNzPSJmaWxsZWQiPjwvY2lyY2xlPgogICAgICAgIDwvbWFya2VyPgogICAgICAgIDxtYXJrZXIgaWQ9Im9wZW5fY2lyY2xlIiB2aWV3Qm94PSIwIDAgOCA4IiByZWZYPSI0IiByZWZZPSI0IiBtYXJrZXJXaWR0aD0iNyIgbWFya2VySGVpZ2h0PSI3IiBvcmllbnQ9ImF1dG8tc3RhcnQtcmV2ZXJzZSI+CiAgICAgICAgICAgIDxjaXJjbGUgY3g9IjQiIGN5PSI0IiByPSIyIiBjbGFzcz0iYmdfZmlsbGVkIj48L2NpcmNsZT4KICAgICAgICA8L21hcmtlcj4KICAgICAgICA8bWFya2VyIGlkPSJiaWdfb3Blbl9jaXJjbGUiIHZpZXdCb3g9IjAgMCA4IDgiIHJlZlg9IjQiIHJlZlk9IjQiIG1hcmtlcldpZHRoPSI3IiBtYXJrZXJIZWlnaHQ9IjciIG9yaWVudD0iYXV0by1zdGFydC1yZXZlcnNlIj4KICAgICAgICAgICAgPGNpcmNsZSBjeD0iNCIgY3k9IjQiIHI9IjMiIGNsYXNzPSJiZ19maWxsZWQiPjwvY2lyY2xlPgogICAgICAgIDwvbWFya2VyPgogICAgPC9kZWZzPgogICAgPHJlY3QgY2xhc3M9ImJhY2tkcm9wIiB4PSIwIiB5PSIwIiB3aWR0aD0iNjgwIiBoZWlnaHQ9IjI1NiI+PC9yZWN0PgogICAgPHJlY3QgeD0iMTIiIHk9Ijg4IiB3aWR0aD0iOTYiIGhlaWdodD0iMzIiIGNsYXNzPSJzb2xpZCBub2ZpbGwiIHJ4PSI0Ij48L3JlY3Q+CiAgICA8dGV4dCB4PSIyNiIgeT0iMTA4IiAgdGV4dExlbmd0aD0iMjQiPlRvcDwvdGV4dD4KICAgIDxsaW5lIHgxPSI0OCIgeTE9IjEwNCIgeDI9IjU2IiB5Mj0iMTA0IiBjbGFzcz0ic29saWQiPjwvbGluZT4KICAgIDx0ZXh0IHg9IjU4IiB5PSIxMDgiICB0ZXh0TGVuZ3RoPSI0MCI+TGV2ZWw8L3RleHQ+CiAgICA8cmVjdCB4PSI0NDQiIHk9IjEyMCIgd2lkdGg9IjE4NCIgaGVpZ2h0PSIzMiIgY2xhc3M9InNvbGlkIG5vZmlsbCIgcng9IjQiPjwvcmVjdD4KICAgIDx0ZXh0IHg9IjQ1OCIgeT0iMTQwIiAgdGV4dExlbmd0aD0iNzIiPkludGVycnVwdDwvdGV4dD4KICAgIDx0ZXh0IHg9IjUzOCIgeT0iMTQwIiAgdGV4dExlbmd0aD0iODAiPkRpc3BhdGNoZXI8L3RleHQ+CiAgICA8cmVjdCB4PSI0NjAiIHk9IjE4NCIgd2lkdGg9IjE2OCIgaGVpZ2h0PSI0OCIgY2xhc3M9InNvbGlkIG5vZmlsbCIgcng9IjQiPjwvcmVjdD4KICAgIDx0ZXh0IHg9IjQ3NCIgeT0iMjA0IiAgdGV4dExlbmd0aD0iNzIiPkludGVycnVwdDwvdGV4dD4KICAgIDx0ZXh0IHg9IjU1NCIgeT0iMjA0IiAgdGV4dExlbmd0aD0iNTYiPkhhbmRsZXI8L3RleHQ+CiAgICA8dGV4dCB4PSI0NzQiIHk9IjIyMCIgIHRleHRMZW5ndGg9IjI0Ij5mb3I8L3RleHQ+CiAgICA8dGV4dCB4PSI1MDYiIHk9IjIyMCIgIHRleHRMZW5ndGg9IjE2Ij5JQzwvdGV4dD4KICAgIDx0ZXh0IHg9IjUzMCIgeT0iMjIwIiAgdGV4dExlbmd0aD0iNzIiPkludGVycnVwdDwvdGV4dD4KICAgIDx0ZXh0IHg9IjYxMCIgeT0iMjIwIiAgdGV4dExlbmd0aD0iOCI+MDwvdGV4dD4KICAgIDx0ZXh0IHg9IjIxOCIgeT0iNzYiICB0ZXh0TGVuZ3RoPSI4Ij4wPC90ZXh0PgogICAgPHRleHQgeD0iMjUwIiB5PSI3NiIgIHRleHRMZW5ndGg9IjY0Ij5Tb2Z0d2FyZTwvdGV4dD4KICAgIDx0ZXh0IHg9IjIxOCIgeT0iMTA4IiAgdGV4dExlbmd0aD0iOCI+MTwvdGV4dD4KICAgIDx0ZXh0IHg9IjI1MCIgeT0iMTA4IiAgdGV4dExlbmd0aD0iNDAiPlRpbWVyPC90ZXh0PgogICAgPHRleHQgeD0iMjE4IiB5PSIxNDAiICB0ZXh0TGVuZ3RoPSI4Ij4yPC90ZXh0PgogICAgPHRleHQgeD0iMjUwIiB5PSIxNDAiICB0ZXh0TGVuZ3RoPSI2NCI+RXh0ZXJuYWw8L3RleHQ+CiAgICA8dGV4dCB4PSIyMTgiIHk9IjE3MiIgIHRleHRMZW5ndGg9IjgiPjM8L3RleHQ+CiAgICA8dGV4dCB4PSIyNTAiIHk9IjE3MiIgIHRleHRMZW5ndGg9IjE2Ij5JQzwvdGV4dD4KICAgIDx0ZXh0IHg9IjI3NCIgeT0iMTcyIiAgdGV4dExlbmd0aD0iNzIiPkludGVycnVwdDwvdGV4dD4KICAgIDx0ZXh0IHg9IjM1NCIgeT0iMTcyIiAgdGV4dExlbmd0aD0iOCI+MDwvdGV4dD4KICAgIDx0ZXh0IHg9IjIxOCIgeT0iMjA0IiAgdGV4dExlbmd0aD0iOCI+NDwvdGV4dD4KICAgIDx0ZXh0IHg9IjI1MCIgeT0iMjA0IiAgdGV4dExlbmd0aD0iMTYiPklDPC90ZXh0PgogICAgPHRleHQgeD0iMjc0IiB5PSIyMDQiICB0ZXh0TGVuZ3RoPSI3MiI+SW50ZXJydXB0PC90ZXh0PgogICAgPHRleHQgeD0iMzU0IiB5PSIyMDQiICB0ZXh0TGVuZ3RoPSI4Ij4xPC90ZXh0PgogICAgPHRleHQgeD0iNDI2IiB5PSIxMDgiICB0ZXh0TGVuZ3RoPSI3MiI+SW50ZXJydXB0PC90ZXh0PgogICAgPHRleHQgeD0iNTA2IiB5PSIxMDgiICB0ZXh0TGVuZ3RoPSI4MCI+Q29udHJvbGxlcjwvdGV4dD4KICAgIDx0ZXh0IHg9IjU5NCIgeT0iMTA4IiAgdGV4dExlbmd0aD0iNDgiPkRyaXZlcjwvdGV4dD4KICAgIDx0ZXh0IHg9IjIxMCIgeT0iNDQiICB0ZXh0TGVuZ3RoPSIxNDQiPklOVEVSUlVQVF9IQU5ETEVSUzwvdGV4dD4KICAgIDxnPgogICAgICAgIDxwYXRoIGQ9Ik0gMTY4LDggQSA0LDQgMCwwLDAgMTY0LDEyIiBjbGFzcz0ibm9maWxsIj48L3BhdGg+CiAgICAgICAgPGxpbmUgeDE9IjE2NCIgeTE9IjEyIiB4Mj0iMTY0IiB5Mj0iNjQiIGNsYXNzPSJzb2xpZCI+PC9saW5lPgogICAgICAgIDxsaW5lIHgxPSIxNjgiIHkxPSI4IiB4Mj0iNjY0IiB5Mj0iOCIgY2xhc3M9InNvbGlkIj48L2xpbmU+CiAgICAgICAgPHBhdGggZD0iTSA2NjQsOCBBIDQsNCAwLDAsMSA2NjgsMTIiIGNsYXNzPSJub2ZpbGwiPjwvcGF0aD4KICAgICAgICA8bGluZSB4MT0iNjY4IiB5MT0iMTIiIHgyPSI2NjgiIHkyPSIxMzIiIGNsYXNzPSJzb2xpZCI+PC9saW5lPgogICAgICAgIDxwYXRoIGQ9Ik0gMTY0LDY0IEEgMTIsMTIgMCwwLDEgMTY0LDgwIiBjbGFzcz0ibm9maWxsIj48L3BhdGg+CiAgICAgICAgPGxpbmUgeDE9IjE2NCIgeTE9IjgwIiB4Mj0iMTY0IiB5Mj0iOTYiIGNsYXNzPSJzb2xpZCI+PC9saW5lPgogICAgICAgIDxwYXRoIGQ9Ik0gMTY0LDk2IEEgMTIsMTIgMCwwLDEgMTY0LDExMiIgY2xhc3M9Im5vZmlsbCI+PC9wYXRoPgogICAgICAgIDxsaW5lIHgxPSIxNjQiIHkxPSIxMTIiIHgyPSIxNjQiIHkyPSIxMjgiIGNsYXNzPSJzb2xpZCI+PC9saW5lPgogICAgICAgIDxwYXRoIGQ9Ik0gMTY0LDEyOCBBIDEyLDEyIDAsMCwxIDE2NCwxNDQiIGNsYXNzPSJub2ZpbGwiPjwvcGF0aD4KICAgICAgICA8bGluZSB4MT0iMTY0IiB5MT0iMTQ0IiB4Mj0iMTY0IiB5Mj0iMTY0IiBjbGFzcz0ic29saWQiPjwvbGluZT4KICAgICAgICA8cGF0aCBkPSJNIDE2NCwxNjQgQSA0LDQgMCwwLDAgMTY4LDE2OCIgY2xhc3M9Im5vZmlsbCI+PC9wYXRoPgogICAgICAgIDxsaW5lIHgxPSIxNjgiIHkxPSIxNjgiIHgyPSIxODQiIHkyPSIxNjgiIGNsYXNzPSJzb2xpZCI+PC9saW5lPgogICAgICAgIDxwb2x5Z29uIHBvaW50cz0iMTg0LDE2NCAxOTIsMTY4IDE4NCwxNzIiIGNsYXNzPSJmaWxsZWQiPjwvcG9seWdvbj4KICAgICAgICA8bGluZSB4MT0iNjQwIiB5MT0iMTM2IiB4Mj0iNjY0IiB5Mj0iMTM2IiBjbGFzcz0ic29saWQiPjwvbGluZT4KICAgICAgICA8cGF0aCBkPSJNIDY2OCwxMzIgQSA0LDQgMCwwLDEgNjY0LDEzNiIgY2xhc3M9Im5vZmlsbCI+PC9wYXRoPgogICAgPC9nPgogICAgPGc+CiAgICAgICAgPHBhdGggZD0iTSAxNDQsNzIgQSA0LDQgMCwwLDAgMTQwLDc2IiBjbGFzcz0ibm9maWxsIj48L3BhdGg+CiAgICAgICAgPGxpbmUgeDE9IjE0MCIgeTE9Ijc2IiB4Mj0iMTQwIiB5Mj0iMTMyIiBjbGFzcz0ic29saWQiPjwvbGluZT4KICAgICAgICA8bGluZSB4MT0iMTQ0IiB5MT0iNzIiIHgyPSIxODQiIHkyPSI3MiIgY2xhc3M9InNvbGlkIj48L2xpbmU+CiAgICAgICAgPHBvbHlnb24gcG9pbnRzPSIxODQsNjggMTkyLDcyIDE4NCw3NiIgY2xhc3M9ImZpbGxlZCI+PC9wb2x5Z29uPgogICAgICAgIDxwYXRoIGQ9Ik0gMTQwLDEzMiBBIDQsNCAwLDAsMCAxNDQsMTM2IiBjbGFzcz0ibm9maWxsIj48L3BhdGg+CiAgICAgICAgPGxpbmUgeDE9IjE0NCIgeTE9IjEzNiIgeDI9IjE4NCIgeTI9IjEzNiIgY2xhc3M9InNvbGlkIj48L2xpbmU+CiAgICAgICAgPHBvbHlnb24gcG9pbnRzPSIxODQsMTMyIDE5MiwxMzYgMTg0LDE0MCIgY2xhc3M9ImZpbGxlZCI+PC9wb2x5Z29uPgogICAgPC9nPgogICAgPGc+CiAgICAgICAgPGxpbmUgeDE9IjEyMCIgeTE9IjEwNCIgeDI9IjE4NCIgeTI9IjEwNCIgY2xhc3M9InNvbGlkIj48L2xpbmU+CiAgICAgICAgPHBvbHlnb24gcG9pbnRzPSIxODQsMTAwIDE5MiwxMDQgMTg0LDEwOCIgY2xhc3M9ImZpbGxlZCI+PC9wb2x5Z29uPgogICAgPC9nPgogICAgPGc+CiAgICAgICAgPHBhdGggZD0iTSAyMDgsNTYgQSA0LDQgMCwwLDAgMjA0LDYwIiBjbGFzcz0ibm9maWxsIj48L3BhdGg+CiAgICAgICAgPGxpbmUgeDE9IjIwNCIgeTE9IjYwIiB4Mj0iMjA0IiB5Mj0iMjEyIiBjbGFzcz0ic29saWQiPjwvbGluZT4KICAgICAgICA8bGluZSB4MT0iMjA4IiB5MT0iNTYiIHgyPSIzNjgiIHkyPSI1NiIgY2xhc3M9InNvbGlkIj48L2xpbmU+CiAgICAgICAgPGxpbmUgeDE9IjIzNiIgeTE9IjU2IiB4Mj0iMjM2IiB5Mj0iMjE2IiBjbGFzcz0ic29saWQiPjwvbGluZT4KICAgICAgICA8cGF0aCBkPSJNIDM2OCw1NiBBIDQsNCAwLDAsMSAzNzIsNjAiIGNsYXNzPSJub2ZpbGwiPjwvcGF0aD4KICAgICAgICA8bGluZSB4MT0iMzcyIiB5MT0iNjAiIHgyPSIzNzIiIHkyPSIyMTIiIGNsYXNzPSJzb2xpZCI+PC9saW5lPgogICAgICAgIDxsaW5lIHgxPSIyMDQiIHkxPSI4OCIgeDI9IjM3MiIgeTI9Ijg4IiBjbGFzcz0ic29saWQiPjwvbGluZT4KICAgICAgICA8bGluZSB4MT0iMjA0IiB5MT0iMTIwIiB4Mj0iMzcyIiB5Mj0iMTIwIiBjbGFzcz0ic29saWQiPjwvbGluZT4KICAgICAgICA8bGluZSB4MT0iMjA0IiB5MT0iMTUyIiB4Mj0iMzcyIiB5Mj0iMTUyIiBjbGFzcz0ic29saWQiPjwvbGluZT4KICAgICAgICA8bGluZSB4MT0iMjA0IiB5MT0iMTg0IiB4Mj0iMzcyIiB5Mj0iMTg0IiBjbGFzcz0ic29saWQiPjwvbGluZT4KICAgICAgICA8cGF0aCBkPSJNIDIwNCwyMTIgQSA0LDQgMCwwLDAgMjA4LDIxNiIgY2xhc3M9Im5vZmlsbCI+PC9wYXRoPgogICAgICAgIDxsaW5lIHgxPSIyMDgiIHkxPSIyMTYiIHgyPSIzNjgiIHkyPSIyMTYiIGNsYXNzPSJzb2xpZCI+PC9saW5lPgogICAgICAgIDxwYXRoIGQ9Ik0gMzcyLDIxMiBBIDQsNCAwLDAsMSAzNjgsMjE2IiBjbGFzcz0ibm9maWxsIj48L3BhdGg+CiAgICA8L2c+CiAgICA8Zz4KICAgICAgICA8bGluZSB4MT0iMzg0IiB5MT0iMTM2IiB4Mj0iNDI0IiB5Mj0iMTM2IiBjbGFzcz0ic29saWQiPjwvbGluZT4KICAgICAgICA8cG9seWdvbiBwb2ludHM9IjQyNCwxMzIgNDMyLDEzNiA0MjQsMTQwIiBjbGFzcz0iZmlsbGVkIj48L3BvbHlnb24+CiAgICA8L2c+CiAgICA8Zz4KICAgICAgICA8bGluZSB4MT0iMzg0IiB5MT0iMTY4IiB4Mj0iNDA4IiB5Mj0iMTY4IiBjbGFzcz0ic29saWQiPjwvbGluZT4KICAgICAgICA8cGF0aCBkPSJNIDQwOCwxNjggQSA0LDQgMCwwLDEgNDEyLDE3MiIgY2xhc3M9Im5vZmlsbCI+PC9wYXRoPgogICAgICAgIDxsaW5lIHgxPSI0MTIiIHkxPSIxNzIiIHgyPSI0MTIiIHkyPSIxOTYiIGNsYXNzPSJzb2xpZCI+PC9saW5lPgogICAgICAgIDxwYXRoIGQ9Ik0gNDEyLDE5NiBBIDQsNCAwLDAsMCA0MTYsMjAwIiBjbGFzcz0ibm9maWxsIj48L3BhdGg+CiAgICAgICAgPGxpbmUgeDE9IjQxNiIgeTE9IjIwMCIgeDI9IjQ0MCIgeTI9IjIwMCIgY2xhc3M9InNvbGlkIj48L2xpbmU+CiAgICAgICAgPHBvbHlnb24gcG9pbnRzPSI0NDAsMTk2IDQ0OCwyMDAgNDQwLDIwNCIgY2xhc3M9ImZpbGxlZCI+PC9wb2x5Z29uPgogICAgPC9nPgo8L3N2Zz4=" alt="interrupts" /></span></p>
<p>Usually, there are more than one interrupt source connected to the external interrupt pin of a hart through an interrupt controller. An interrupt controller driver is responsible for determining the source of an external interrupt and dispatching the appropriate handler. At configuration time, it attaches an interrupt handler to <a href="constant.INTERRUPT_EXTERNAL.html" title="INTERRUPT_EXTERNAL"><code>INTERRUPT_EXTERNAL</code></a>. The interrupt handler, when called, queries the currently pending interrupt (let’s assume the interrupt number is <code>n</code>). It may call <a href="trait.InterruptControllerToPort.html#tymethod.enable_external_interrupts" title="InterruptControllerToPort::enable_external_interrupts"><code>InterruptControllerToPort::enable_external_interrupts</code></a> to allow nested interrupts (assuming the underlying hardware supports that). Then it fetches the corresponding interrupt handler by indexing <a href="../r3_kernel/trait.KernelCfg2.html#associatedconstant.INTERRUPT_HANDLERS"><code>INTERRUPT_HANDLERS</code></a> by <code>n + INTERRUPT_PLATFORM_START</code> and calls that.</p>
<p>The <a href="../r3_kernel/trait.PortInterrupts.html"><code>PortInterrupts</code></a> implementation generated by <code>use_port!</code> delegates method calls to an interrupt controller driver through <a href="trait.InterruptController.html" title="InterruptController"><code>InterruptController</code></a> for these interrupt numbers.</p>
<p>Your kernel trait type should be combined with an interrupt controller driver by implementing <a href="trait.InterruptController.html" title="InterruptController"><code>InterruptController</code></a>. Most systems are equipped with <a href="https://github.com/riscv/riscv-plic-spec/blob/master/riscv-plic.adoc">Platform-Level Interrupt Controller (PLIC)</a>, whose driver is provided by <a href="macro.use_plic.html" title="use_plic!"><code>use_plic!</code></a>. PLIC does not support pending or clearing interrupt lines.</p>
<h2 id="emulation"><a href="#emulation">Emulation</a></h2><h3 id="lrsc-emulation"><a href="#lrsc-emulation"><code>LR</code>/<code>SC</code> Emulation</a></h3>
<p>The <strong><code>emulate-lr-sc</code></strong> Cargo feature enables the software emulation of the <code>lr</code> (load-reserved) and <code>sc</code> (store-conditional) instructions. This is useful for a target that supports atomic memory operations but doesn’t support these particular instructions, such as FE310. The following limitations should be kept in mind when using this feature:</p>
<ul>
<li>The software emulation is slow and non-preemptive (increases the worst-case interrupt latency).</li>
<li>The addition of the software emulation code introduces a non-negligible code size overhead.</li>
<li>It doesn’t do actual bus snooping and therefore it will behave incorrectly if there’s another bus master<!-- TODO: find a better, non-offensive word --> controlling the same memory address.</li>
<li>Instructions with <code>rd = sp</code> are not supported and will behave incorrectly. This shouldn’t be a problem in practice.</li>
<li>It doesn’t do actual bus snooping and can’t detect a conflicting memory write that doesn’t modify the memory contents. This shouldn’t be a problem for the atomic operations currently provided by the standard library.</li>
</ul>
<p><code>lr</code> and <code>sc</code> instructions are generated when the program uses atomic operations that aren’t covered by AMO instructions (e.g., <code>Atomic*::compare_and_swap</code>).</p>
<h3 id="mstatusmpie-maintenance"><a href="#mstatusmpie-maintenance"><code>mstatus.MPIE</code> Maintenance</a></h3>
<p>The <strong><code>maintain-pie</code></strong> Cargo feature enables the work-around for the hardware quirk where the <code>mret</code> instruction clears <code>mstatus.MPIE</code> in violation of the specification. This quirk is found in QEMU 4.2 and K210. The common symptom is methods returning <code>Err(BadContext)</code>.</p>
<h2 id="implementation"><a href="#implementation">Implementation</a></h2>
<p>The CPU Lock state is mapped to <code>mstatus.MIE</code> (global interrupt-enable). Unmanaged interrupts aren’t supported.</p>
<h3 id="context-state"><a href="#context-state">Context State</a></h3>
<p>The state of an interrupted thread is stored to the interrupted thread’s stack in the following form:</p>

<div class='information'><div class='tooltip ignore'>ⓘ</div></div><div class="example-wrap"><pre class="rust rust-example-rendered ignore"><code><span class="attribute">#[<span class="ident">repr</span>(<span class="ident">C</span>)]</span>
<span class="kw">struct</span> <span class="ident">ContextState</span> {
    <span class="comment">// Second-level state (SLS)</span>
    <span class="comment">// ------------------------</span>
    <span class="comment">//</span>
    <span class="comment">// Includes everything that is not included in the first-level state. These</span>
    <span class="comment">// are moved between memory and registers only when switching tasks.</span>

    <span class="comment">// SLS.HDR: Second-level state, header</span>
    <span class="comment">//</span>
    <span class="comment">// The `mstatus` field preserves the state of `mstatus.FS[1]`.</span>
    <span class="comment">// `mstatus.FS[0]` is assumed to `1`. This means `mstatus.FS` can only take</span>
    <span class="comment">// one of the following states: Initial and Dirty.</span>
    <span class="comment">// Irrelevant bits are don&#39;t-care (hence `_part`).</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;f&quot;</span>)]</span>
    <span class="ident">mstatus_part</span>: <span class="ident">usize</span>,

    <span class="comment">// SLS.F: Second-level state, FP registers</span>
    <span class="comment">//</span>
    <span class="comment">// This portion exists only if `mstatus.FS[1] != 0`.</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;f&quot;</span>)]</span>
    <span class="ident">f8</span>: [<span class="ident">FReg</span>; <span class="number">2</span>],  <span class="comment">// fs0-fs1</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;f&quot;</span>)]</span>
    <span class="ident">f18</span>: [<span class="ident">FReg</span>; <span class="number">10</span>], <span class="comment">// fs2-fs11</span>

    <span class="comment">// SLS.X: Second-level state, X registers</span>
    <span class="ident">x8</span>: <span class="ident">usize</span>,  <span class="comment">// s0/fp</span>
    <span class="ident">x9</span>: <span class="ident">usize</span>,  <span class="comment">// s1</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;e&quot;</span>))]</span>
    <span class="ident">x18</span>: <span class="ident">usize</span>, <span class="comment">// s2</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;e&quot;</span>))]</span>
    <span class="ident">x19</span>: <span class="ident">usize</span>, <span class="comment">// s3</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;e&quot;</span>))]</span>
    <span class="ident">x20</span>: <span class="ident">usize</span>, <span class="comment">// s4</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;e&quot;</span>))]</span>
    <span class="ident">x21</span>: <span class="ident">usize</span>, <span class="comment">// s5</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;e&quot;</span>))]</span>
    <span class="ident">x22</span>: <span class="ident">usize</span>, <span class="comment">// s6</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;e&quot;</span>))]</span>
    <span class="ident">x23</span>: <span class="ident">usize</span>, <span class="comment">// s7</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;e&quot;</span>))]</span>
    <span class="ident">x24</span>: <span class="ident">usize</span>, <span class="comment">// s8</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;e&quot;</span>))]</span>
    <span class="ident">x25</span>: <span class="ident">usize</span>, <span class="comment">// s9</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;e&quot;</span>))]</span>
    <span class="ident">x26</span>: <span class="ident">usize</span>, <span class="comment">// s10</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;e&quot;</span>))]</span>
    <span class="ident">x27</span>: <span class="ident">usize</span>, <span class="comment">// s11</span>

    <span class="comment">// First-level state (FLS)</span>
    <span class="comment">// -----------------------</span>
    <span class="comment">//</span>
    <span class="comment">// This section is comprised of caller-saved registers. In an exception</span>
    <span class="comment">// handler, saving/restoring this set of registers at entry and exit allows</span>
    <span class="comment">// it to call Rust functions.</span>
    <span class="comment">//</span>
    <span class="comment">// The registers are ordered in the encoding order (rather than grouping</span>
    <span class="comment">// them by their purposes, as done by Linux and FreeBSD) to improve the</span>
    <span class="comment">// compression ratio very slightly when transmitting the code over a</span>
    <span class="comment">// network.</span>

    <span class="comment">// FLS.F: First-level state, FP registers</span>
    <span class="comment">//</span>
    <span class="comment">// This portion exists only if `mstatus.FS[1] != 0`.</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;f&quot;</span>)]</span>
    <span class="ident">f0</span>: [<span class="ident">FReg</span>; <span class="number">8</span>],  <span class="comment">// ft0-ft7</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;f&quot;</span>)]</span>
    <span class="ident">f10</span>: [<span class="ident">FReg</span>; <span class="number">8</span>], <span class="comment">// fa0-fa7</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">target_feature</span> <span class="op">=</span> <span class="string">&quot;f&quot;</span>)]</span>
    <span class="ident">f28</span>: [<span class="ident">FReg</span>; <span class="number">4</span>], <span class="comment">// ft8-ft11</span>
    <span class="ident">fcsr</span>: <span class="ident">usize</span>,
    <span class="ident">_pad</span>: [<span class="ident">u8</span>; (<span class="ident">max</span>(<span class="ident">FLEN</span>, <span class="ident">XLEN</span>) <span class="op">-</span> <span class="ident">XLEN</span>) <span class="op">/</span> <span class="number">8</span>],

    <span class="comment">// FLS.X: First-level state, X registers</span>
    <span class="ident">x1</span>: <span class="ident">usize</span>,  <span class="comment">// ra</span>
    <span class="ident">x5</span>: <span class="ident">usize</span>,  <span class="comment">// t0</span>
    <span class="ident">x6</span>: <span class="ident">usize</span>,  <span class="comment">// t1</span>
    <span class="ident">x7</span>: <span class="ident">usize</span>,  <span class="comment">// t2</span>
    <span class="ident">x10</span>: <span class="ident">usize</span>, <span class="comment">// a0</span>
    <span class="ident">x11</span>: <span class="ident">usize</span>, <span class="comment">// a1</span>
    <span class="ident">x12</span>: <span class="ident">usize</span>, <span class="comment">// a2</span>
    <span class="ident">x13</span>: <span class="ident">usize</span>, <span class="comment">// a3</span>
    <span class="ident">x14</span>: <span class="ident">usize</span>, <span class="comment">// a4</span>
    <span class="ident">x15</span>: <span class="ident">usize</span>, <span class="comment">// a5</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">e</span>))]</span>
    <span class="ident">x16</span>: <span class="ident">usize</span>, <span class="comment">// a6</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">e</span>))]</span>
    <span class="ident">x17</span>: <span class="ident">usize</span>, <span class="comment">// a7</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">e</span>))]</span>
    <span class="ident">x28</span>: <span class="ident">usize</span>, <span class="comment">// t3</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">e</span>))]</span>
    <span class="ident">x29</span>: <span class="ident">usize</span>, <span class="comment">// t4</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">e</span>))]</span>
    <span class="ident">x30</span>: <span class="ident">usize</span>, <span class="comment">// t5</span>
    <span class="attribute">#[<span class="ident">cfg</span>(<span class="ident">not</span>(<span class="ident">e</span>))]</span>
    <span class="ident">x31</span>: <span class="ident">usize</span>, <span class="comment">// t6</span>
    <span class="ident">pc</span>: <span class="ident">usize</span>, <span class="comment">// original program counter</span>
}</code></pre></div>
<p><code>x2</code> (<code>sp</code>) is stored in <a href="../r3_kernel/task/struct.TaskCb.html#structfield.port_task_state"><code>TaskCb::port_task_state</code></a>. The stored stack pointer is only aligned to word boundaries.</p>
<p>The idle task (the implicit task that runs when <code>*</code><a href="../r3_kernel/struct.State.html#method.running_task_ptr"><code>running_task_ptr</code></a><code>().is_none()</code>) always execute with <code>sp == 0</code>. For the idle task, saving and restoring the context store is essentially replaced with no-op or loads of hard-coded values. In particular, <code>pc</code> is always “restored” with the entry point of the idle task.</p>
<p>When a task is activated, a new context state is created inside the task’s stack. By default, only essential registers are preloaded with known values. The <strong><code>preload-registers</code></strong> Cargo feature enables preloading for all <code>x</code> registers, which might help in debugging at the cost of performance and code size.</p>
<p>The trap handler stores a first-level state directly below the current stack pointer. This means <strong>the stack pointer must be aligned to a <code>max(XLEN, FLEN)</code>-bit boundary all the time</strong>. This requirement is weaker than the standard ABI’s requirement, so it shouldn’t pose a problem in most cases.</p>
<h3 id="processor-modes"><a href="#processor-modes">Processor Modes</a></h3>
<p>All code executes in Machine mode by default. The value of <code>mstatus.MPP</code> is always <code>M</code> (<code>0b11</code>). Other modes can be selected by <a href="trait.ThreadingOptions.html#associatedconstant.PRIVILEGE_LEVEL" title="ThreadingOptions::PRIVILEGE_LEVEL"><code>ThreadingOptions::PRIVILEGE_LEVEL</code></a>, which changes all CSRs and CSR values accordingly.</p>
<style type="text/css">
/* Cover image, something that is definitely relevant to the subject */
.distractor {
    margin: 0 auto;
    max-width: 600px;
}
.distractor > a {
    display: block;
    background-size: cover;
    /* background: ...; — specified by inline style */
    /* padding-bottom: ...; — specified by inline style */
}

/* #![doc(html_logo_url = ...)] */
body.theme-dark .logo-container > img[src$="logo-small.svg"] {
    filter: brightness(0) invert(1) brightness(0.9);
}
body.theme-ayu .logo-container > img[src$="logo-small.svg"] {
    filter: brightness(0) invert(1) brightness(0.85);
}

/* Table of contents */
.toc-header + ul {
    background: rgba(128, 128, 128, 0.1);
    margin: 1em 0; padding: 1em;
    width: 40%;
    min-width: 280px;
    border: 1px solid rgba(128, 128, 128, 0.2);
    font-family: 'Fira Sans'; /* The UI/heading font of rustdoc */
    font-size: 95%;
}
.toc-header + ul::before {
    content: "Contents";
    font-weight: bold;
}
.toc-header + ul ul { margin-bottom: 0; }
.toc-header + ul li { list-style: none; }

/* Poor man's admonition
 *
 * # Usage
 *
 * ## Normal
 *
 *     <div class="admonition-follows"></div>
 *
 *     > **Title:** lorem ipsum lorem ipsum lorem ipsum lorem ipsum lorem ipsum
 *     > lorem ipsum
 *
 * ## Collapsible
 *
 *     <div class="admonition-follows"></div>
 *
 *     > <details>
 *     > <summary>Title</summary>
 *     >
 *     > lorem ipsum lorem ipsum lorem ipsum lorem ipsum lorem ipsum lorem ipsum
 *     >
 *     > </details>
 */
.admonition-follows + blockquote {
    background: rgba(128, 128, 128, 0.1) !important;
    margin: 1em !important; padding: 1em 1em 0 !important;
    color: inherit !important; overflow: hidden;
}
.admonition-follows + blockquote::after { /* collapsible padding */
    content: ""; display: block; margin-top: 1em;
}

.admonition-follows + blockquote summary {
    cursor: pointer;
    will-change: opacity;
    user-select: none;
    -webkit-user-select: none;
    font-weight: bold;
}
.admonition-follows + blockquote summary:not([open]):not(:hover) {
    opacity: 0.5;
}
.admonition-follows + blockquote summary + * {
    margin-top: 1em;
}

/* Display a warning if some Cargo features are disabled. */
.disabled-feature-warning > p > span:before { content: "Warning:"; font-weight: bold; }
.disabled-feature-warning > p > span:after { content: " This documentation was built without a "; }
.disabled-feature-warning > p > code:before { content: "--all-features"; }
.disabled-feature-warning > p:after { content: " build option. Some items might be missing."; }

/* Center an inline image
 *
 * # Usage
 *
 *    <span class="center">![kernel-traits]</span>
 *
 *    [kernel-traits]: data:image/svg+xml;base64,< super long base64 data >
 *
 * The image wouldn't render if `![kernel-traits]` were wrapped with `<center>`
 * because the Markdown processor doesn't do Markdown processing inside a block
 * element. On the other hand, it thinks `<span>` is an inline element (by
 * default), so markups inside `<span>` are processed.
 *
 * For diagrams processed by `::svgbobdoc`, just use `<center>`.
 */
span.center {
    display: block;
    text-align: center;
}

/* Add margins to SvgBob images */
span.center img, center img {
    border: 10px solid white;
    background: white;
}

/* Auto-invert SvgBob images in a dark theme */
body.theme-dark span.center img, body.theme-dark center img {
    filter: invert(88%);
}

body.theme-ayu span.center img, body.theme-ayu center img {
    filter: invert(89%) sepia(90%) hue-rotate(180deg);
}

/* FIXME: rustdoc's intra-doc processor generates a warning when it encounters a
   bracketed text with an unknown link target. This misfires for CSS attribute
   selectors. Make rustdoc happy by defining a fake link target. I'm not sure if
   it's worth reporting.

[open]: #dummy

*/
</style>
<script type="application/javascript">
<!--
// Monitors the current rustdoc theme and adds `.theme-NAME` to `<body>`
function initThemeMonitor() {
    if (typeof switchTheme !== 'function' ||
        typeof themeStyle !== 'object' ||
        typeof document.body.classList === 'undefined')
    {
        // Something is wrong, don't do anything
        return;
    }

    var currentClassName = null;
    function onApplyTheme(name) {
        if (currentClassName != null) {
            document.body.classList.remove(currentClassName);
        }
        currentClassName = "theme-" + name;
        document.body.classList.add(currentClassName);
    }

    var match = themeStyle.href.match(/\/([a-z]+)(-[-a-zA-Z0-9.]*)?\.css$/);
    var currentStyle = (match && match[1]) || "light";
    onApplyTheme(currentStyle);

    // Intercept calls to `switchTheme`
    var originalSwitchTheme = switchTheme;
    switchTheme = function (_0, _1, newTheme) {
        onApplyTheme(newTheme);
        originalSwitchTheme.apply(this, arguments);
    };
}

if (document.readyState === 'interactive' || document.readyState === 'complete') {
    initThemeMonitor();
} else {
    document.addEventListener('DOMContentLoaded', initThemeMonitor);
}
-->
</script>
</div></details><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="mod" href="_changelog_/index.html" title="r3_port_riscv::_changelog_ mod">_changelog_</a></div><div class="item-right docblock-short"><p>Changelog</p>
</div></div></div><h2 id="macros" class="small-section-header"><a href="#macros">Macros</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="macro" href="macro.use_mtime.html" title="r3_port_riscv::use_mtime macro">use_mtime</a></div><div class="item-right docblock-short"><p>Attach the implementation of <a href="../r3_kernel/trait.PortTimer.html"><code>PortTimer</code></a> based on the RISC-V machine-mode
timer (<code>mtime</code>/<code>mtimecfg</code>) to a given kernel trait type. This macro also
implements <a href="trait.Timer.html"><code>Timer</code></a> on the kernel trait type.
<strong>Requires <a href="trait.MtimeOptions.html" title="MtimeOptions"><code>MtimeOptions</code></a>.</strong></p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="macro" href="macro.use_plic.html" title="r3_port_riscv::use_plic macro">use_plic</a></div><div class="item-right docblock-short"><p>Implement <a href="trait.InterruptController.html"><code>InterruptController</code></a> and <a href="trait.Plic.html" title="Plic"><code>Plic</code></a> on the given kernel trait
type using the Platform-Level Interrupt Controller (PLIC) on the target.
<strong>Requires <a href="trait.PlicOptions.html" title="PlicOptions"><code>PlicOptions</code></a> and <a href="trait.InterruptControllerToPort.html"><code>InterruptControllerToPort</code></a>.</strong></p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="macro" href="macro.use_port.html" title="r3_port_riscv::use_port macro">use_port</a></div><div class="item-right docblock-short"><p>Define a kernel trait type implementing <a href="../r3_kernel/trait.PortThreading.html"><code>PortThreading</code></a>,
<a href="../r3_kernel/trait.PortInterrupts.html"><code>PortInterrupts</code></a>, <a href="trait.InterruptControllerToPort.html"><code>InterruptControllerToPort</code></a>, and <a href="trait.EntryPoint.html"><code>EntryPoint</code></a>.
<strong>Requires <a href="trait.ThreadingOptions.html" title="ThreadingOptions"><code>ThreadingOptions</code></a>, <a href="trait.Timer.html"><code>Timer</code></a>, and <a href="trait.InterruptController.html"><code>InterruptController</code></a>.</strong></p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="macro" href="macro.use_rt.html" title="r3_port_riscv::use_rt macro">use_rt</a></div><div class="item-right docblock-short"><p>Generate entry points using [<code>::riscv_rt</code>]. <strong>Requires <a href="trait.EntryPoint.html"><code>EntryPoint</code></a> to
be implemented.</strong></p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="macro" href="macro.use_sbi_timer.html" title="r3_port_riscv::use_sbi_timer macro">use_sbi_timer</a></div><div class="item-right docblock-short"><p>Attach the implementation of <a href="../r3_kernel/trait.PortTimer.html"><code>PortTimer</code></a> based on <a href="https://github.com/riscv-non-isa/riscv-sbi-doc">the RISC-V Supervisor
Binary Interface</a> Timer Extension (EID #0x54494D45 “TIME”) and <code>time[h]</code>
CSR to a given kernel trait type.
This macro also implements <a href="trait.Timer.html"><code>Timer</code></a> on the kernel trait type.
<strong>Requires <a href="trait.SbiTimerOptions.html" title="SbiTimerOptions"><code>SbiTimerOptions</code></a>.</strong></p>
</div></div></div><h2 id="constants" class="small-section-header"><a href="#constants">Constants</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="constant" href="constant.INTERRUPT_EXTERNAL.html" title="r3_port_riscv::INTERRUPT_EXTERNAL constant">INTERRUPT_EXTERNAL</a></div><div class="item-right docblock-short"><p>The interrupt number for external interrupts.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="constant" href="constant.INTERRUPT_PLATFORM_START.html" title="r3_port_riscv::INTERRUPT_PLATFORM_START constant">INTERRUPT_PLATFORM_START</a></div><div class="item-right docblock-short"><p>The first interrupt number allocated for use by an interrupt controller
driver.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="constant" href="constant.INTERRUPT_SOFTWARE.html" title="r3_port_riscv::INTERRUPT_SOFTWARE constant">INTERRUPT_SOFTWARE</a></div><div class="item-right docblock-short"><p>The interrupt number for software interrupts.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="constant" href="constant.INTERRUPT_TIMER.html" title="r3_port_riscv::INTERRUPT_TIMER constant">INTERRUPT_TIMER</a></div><div class="item-right docblock-short"><p>The interrupt number for timer interrupts.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="constant" href="constant.PRIVILEGE_LEVEL_MACHINE.html" title="r3_port_riscv::PRIVILEGE_LEVEL_MACHINE constant">PRIVILEGE_LEVEL_MACHINE</a></div><div class="item-right docblock-short"><p>The RISC-V privilege level encoding for the machine level.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="constant" href="constant.PRIVILEGE_LEVEL_SUPERVISOR.html" title="r3_port_riscv::PRIVILEGE_LEVEL_SUPERVISOR constant">PRIVILEGE_LEVEL_SUPERVISOR</a></div><div class="item-right docblock-short"><p>The RISC-V privilege level encoding for the supervisor level.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="constant" href="constant.PRIVILEGE_LEVEL_USER.html" title="r3_port_riscv::PRIVILEGE_LEVEL_USER constant">PRIVILEGE_LEVEL_USER</a></div><div class="item-right docblock-short"><p>The RISC-V privilege level encoding for the user/application level.</p>
</div></div></div><h2 id="traits" class="small-section-header"><a href="#traits">Traits</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.EntryPoint.html" title="r3_port_riscv::EntryPoint trait">EntryPoint</a></div><div class="item-right docblock-short"><p>Defines the entry points of a port instantiation. Implemented by
<a href="macro.use_port.html" title="use_port!"><code>use_port!</code></a>.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.InterruptController.html" title="r3_port_riscv::InterruptController trait">InterruptController</a></div><div class="item-right docblock-short"><p>An abstract interface to an interrupt controller. Implemented by
<a href="macro.use_plic.html" title="use_plic!"><code>use_plic!</code></a>.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.InterruptControllerToPort.html" title="r3_port_riscv::InterruptControllerToPort trait">InterruptControllerToPort</a></div><div class="item-right docblock-short"><p>An API intended to be used by an interrupt controller driver. Implemented by
<a href="macro.use_port.html" title="use_port!"><code>use_port!</code></a>.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.MtimeOptions.html" title="r3_port_riscv::MtimeOptions trait">MtimeOptions</a></div><div class="item-right docblock-short"><p>The options for <a href="macro.use_mtime.html" title="use_mtime!"><code>use_mtime!</code></a>.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.Plic.html" title="r3_port_riscv::Plic trait">Plic</a></div><div class="item-right docblock-short"><p>Provides access to a system-global PLIC instance. Implemented by
<a href="macro.use_plic.html" title="use_plic!"><code>use_plic!</code></a>.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.PlicOptions.html" title="r3_port_riscv::PlicOptions trait">PlicOptions</a></div><div class="item-right docblock-short"><p>The options for <a href="macro.use_plic.html" title="use_plic!"><code>use_plic!</code></a>.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.SbiTimerOptions.html" title="r3_port_riscv::SbiTimerOptions trait">SbiTimerOptions</a></div><div class="item-right docblock-short"><p>The options for <a href="macro.use_sbi_timer.html" title="use_sbi_timer!"><code>use_sbi_timer!</code></a>.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.ThreadingOptions.html" title="r3_port_riscv::ThreadingOptions trait">ThreadingOptions</a></div><div class="item-right docblock-short"><p>The configuration of the port.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.Timer.html" title="r3_port_riscv::Timer trait">Timer</a></div><div class="item-right docblock-short"><p>An abstract inferface to a port timer driver. Implemented by
<a href="macro.use_mtime.html" title="use_mtime!"><code>use_mtime!</code></a> and <a href="macro.use_sbi_timer.html" title="use_sbi_timer!"><code>use_sbi_timer!</code></a>.</p>
</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../" data-current-crate="r3_port_riscv" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0-nightly (29e4a9ee0 2022-08-10)" ></div></body></html>